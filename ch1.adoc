= Chapter 1: Container and Contrail foundations
:toc:
:toc-placement: preamble
:source-highlighter: pygments
:source-highlighter: coderay
:source-highlighter: prettify
:highlightjs-theme: googlecode
:coderay-linenums-mode: table
:coderay-linenums-mode: inline

== Containers overview

=== Understanding containers

Two decades ago Virtualization was the most fashionable keyword in IT as there was a revolution in the way we build servers. It was mainly about the adoption of Virtual machine instead of dedicated physical server in building applications  
Back in that time Virtual Machine was a clear winner (also valid today)  when it comes to scaling, portability, capacity management, cost, ..,etc  and you can find tones of comparison between the two approaches  

If Virtualization was the keyword that sums it up, the keywords of today are Cloud , SDN and Containers  

Today, the heavily discussed comparison would be between VM and Containers promising a new way to build and scale applications.
While many small organizations are thinking of containers as something too early to adopt, the simple fact that Google stated that “From Gmail to YouTube to Search, everything at Google runs in containers, we run two billion container a week” might give you a clue where the industry is heading 


But what is Container and how is it comparable to VM?

From technical prospect container is rooted from the Cgroups and namespaces concept in Linux but the name might be inspired by the Actual metal cargo shipping containers that you see on ships 
As both share the ideas of isolating contents , carrier independence , easy movement , …,etc 

Container is a logical packaging mechanism, you can think of it as Lightweight virtualization that run an application and its dependencies in the same operating system but in differnet context which remove the need to replicate an entire operating system as shown in the diagram. By doing so Application would be confined in a lightweight package that could be developed/tested individually then implemented and scaled much faster than the tradition VM as Developer just need to build/configure this light peace of software. currently most of the application has been containerized and publicly available. And finally there is no need to manage/support one OS per application 

image::https://user-images.githubusercontent.com/2038044/56472464-b59fd400-642c-11e9-8642-b67cd0a9577e.png[]


Many developers would call the Container Runtime “the Hypervisor of Containers” Although this is not a technically correct term, but it may be useful only to visualize the hierarchy.

As in the VM technologies, the most common Hypervisors are VMware ESX/ESXi and KVM. In the Container technologies Rkt and Docker are the most known with Docker being the most widely deployed one. 
Before we give an overview of Docker let’s see some useful numbers in comparing VM vs Container 
 
=== Juniper VSRX vs CSRX 

Currently most of common applications such as Redis, Ngnix, Mongo , MySQL, WordPress, Jenkins , Kibana and Perl have been containerized and offered publicly in https://hub.docker.com allowing developers to build/test application quickly 

There are a lot of tests that compare performance and scaling for a giving application when it runs on Container vs VM. All of this comparison stress on the benefits of running your application in container.

But what about network functions NFV such as firewalls , NAT , Routing , …,etc 
when it comes to VM based NFV, most of network vendors already implemented a Virtualized flavor of the hardware equipment that could be run on a hypervisor on standard x86 hardware
VSRX is a Juniper SRX Series Services Gateway in a virtualized form factor built on Junos, and delivers networking and security features similar to 
those available for SRX

when it comes to containerized based NFV, Not all vendors offer that 
CSRX is the industry first containerized firewall offering a Compact footprint, high-density firewall for virtualized and cloud environments 

In the comparison below between CSRX vs VSRX we can see the idea of CSRX being lightweight NFV but kindly be aware this comes at a cost, there are some features that won’t exist in containerized based NFV (VPN in the CSRX is one example) but is that a big drawbacks of the containerized based NFV?
In fact not as deploying applications in a containerized style means micro-services technique where we split the application into different smaller services each part (container in that case)  is doing a specific job. So there will be no need to have a NFV container that do everything in the same time.


                      vSRX	                    cSRX
    Use Cases	  Integrated routing,   	L4-L7 Security, Low Footprint
                security, NAT, VPN, 
                High Performance
    Memory
   Requirement	      4GB Minimum               	In MB’s
    NAT	                Yes	                   Yes
    IPSec VPN	          Yes	                   No
    Boot-up Time	    ~minutes               	<1second
    Image size	        In GB’s	               In MB’s


=== Understanding Docker

As we have discussed, containers allow a developer to package up an application with all of the parts it needs, such as libraries and other dependencies, and ship it all out as one package
Docker is the software to facilitate creating, deploying, and running containers 

The starting point would be the source code of the Image “Docker file” from them you can build the “Docker Image” this image can be stored and distributed to any registry -most common Docker hub- and finally you use this image to run the containers.

Docker uses a client-server architecture. The Docker client and daemon can run on the same system, or you can connect a Docker client to a remote Docker daemon
The Docker daemon, does the heavy lifting of building, running, and distributing your Docker containers. The Docker client and daemon communicate using a REST API, over UNIX sockets or a network interface.

image::https://user-images.githubusercontent.com/2038044/56850572-7eb93a80-68d2-11e9-973e-f827801c5909.png[]

Containers doesn’t exists in a vacuum and in production you won’t have just one host with multiple container but multiples of hosts running 100s if not 1000s of containers,
 which raise two important sets of questions 

1- How these containers communicate with each other on the same host or in different host as well with outside world? Basically, the networking aspect of containers 

2- Who determine which containers get launch over which host? and based on what? Upgrade? Number of containers per application? Basically, The orchestration aspect 


we will try to answer these two questions in detail for the rest of the book but if you want a quick answer just think of Contrail and Kubernetes !!
let’s start first lay the basics foundation of contrail 


== Contrail overview 

Contrail Networking:

Contrail Networking provides dynamic end-to-end networking policy and control for any cloud, any workload, and any deployment, from a single user interface by translating abstract workflows into specific policies.
although our focus in this book would be building a secure container network orchestrated by Kubernetes but contrail can build Virtual networks that integrate container, VM and BMS
but what is virtual network ?
Virtual Networks (VNs) are a key concept in the Contrail System. Virtual networks are logical constructs implemented on top of the physical networks. Virtual networks are used to replace VLAN-based isolation and provide multi-tenancy in a virtualized data center. Each tenant or an application can have one or more virtual networks. Each virtual network is isolated from all the other virtual networks unless explicitly allowed by security policy.
Virtual networks can be extended to physical networks using a gateway. Finally, Virtual networks are used to implement Network Function Virtualization (NFV) and service chaining.
as explained in the diagram where Network operate only deal with the logical abstraction of the network then contrail do the heavy lifting of building polices, exchanging routes, building tunnels on the physical topology. 


image::https://user-images.githubusercontent.com/2038044/56851379-782fc080-68dc-11e9-80f0-5a0117ac1226.png[]
image::https://user-images.githubusercontent.com/2038044/56851391-9dbcca00-68dc-11e9-8e12-835911a46e5c.png[]

=== Contrail Architecture Fundamentals 

Contrail run in Logically centralized, physically distributed model as it has two main components, Contrail controller and Contrail vrouter 
the Controller is the Control and management plane that Manages/configures the vrouter and Collects/presents analytics
Contrail vrouter is the Forwarding plane that Provides Layer 2/3 services , Distributed firewall capabilities and  Implements policies between virtual networks  

Contrail integrates with many orchestrator such as OpenStack , VMware , Kubernetes , OpenShift and Mesos and use multiple protocols to provide SDN to these orchestrators as shown in the diagram where 

XMPP : Extensible Messaging and Presence Protocol (XMPP) is an open XML technology for real-time communication defined in RFC 6120, in Contrail it offers two main functionality, distributing routing information and pushing configuration, which are similar to what IBGP do in MPLS VPNs model plus NETCONF in device management. XMPP is also used to exchange operational state, statistics, logs and events 

BGP: is used to exchange router with physical router and in same case Contrail device manager can use Netconf to configure this Gateway

EVPN: Ethernet VPN is a standards-based technology RFC 7432 that provides virtual multipoint bridged connectivity between different Layer 2 domains over an IP network.
Contrail controller exchange EVPN routes with TOR switches (acting as L2 VXLAN GW) to offer faster recovery with active-active VXLAN forwarding 

MPLSoGRE/UDP or VXLAN: are three different kind of overlay tunnels to carry traffic over IP network. They are all IP-UDP packet but in VXLAN we use the VNI values in VXLAN header for segmentation where in MPLSoGRE and MPLSoUDP we use the MPLS label value for segmentation 

To simplify the relation between contrail vrouter, contrail controller and the IP Fabric from the prospective of the Architecture prospective, let’s compare it to MPLS VPN model in any services provider  
vrouter is like PE router and the VM/container is like CE but vrouter is just a slave of contrail controller. and when it comes to BMS the TOR would be the PE 

image::https://user-images.githubusercontent.com/2038044/56851395-b1683080-68dc-11e9-84b0-f7fbfe00b1bc.png[]


=== Contrail VRouter

Contrail vrouter on the compute node/host:

Any container needs a compute node to host it. This host could be a BMS in your DC, or a VM (VM either in your DC or in public cloud). In this book, we will be using compute nodes hosted in AWS

for a compute node in the default docker setup, containers on the same host communicate with each other as well with other containers/services hosted on other host with Docker bridge
but with contrail networking, on each compute the vrouter creates VRF per virtual network 
offering long list of feature as will discuss 
 
From the prospective of control plane the vrouter relay on XMPP to 

* Receive low-level configuration (routing instances and forwarding policy) 
* Exchange routes
* Install forwarding state into the forwarding plane.
* Report analytics (logs, statistics, and events)

From the prospective of data plan the vrouter would 

* Apply forwarding policy for the first packet of each new flow then install a flow entry in the flow table of the forwarding plan.
* Proxy DHCP, ARP, and DNS. 
* Encapsulating/decapsulating packets sent to or received from the overlay network.
* Assign received packet from the overlay network to a routing instance based on the MPLS label or Virtual Network Identifier (VNI).
* Forwarding the packer after a Destination address lookup (IP or MAC) in the Forwarding Information Base (FIB) 

image::https://user-images.githubusercontent.com/2038044/56898486-2794a080-6a5f-11e9-9fd1-64d5275cbce3.png[]


